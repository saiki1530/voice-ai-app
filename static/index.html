<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Voice AI</title>
</head>
<body>
  <h2>Hỏi AI bằng giọng nói hoặc gõ câu hỏi</h2>
  <button onclick="startRecording()">Nhấn để nói</button>

  <div style="margin-top: 20px;">
    <input type="text" id="textInput" placeholder="Hoặc nhập câu hỏi tại đây..." style="width: 300px; padding: 8px;" />
    <button onclick="askText()">Gửi</button>
  </div>

  <div style="margin-top: 20px;">
    <label>Chọn ngôn ngữ:</label>
    <select id="languageSelect" onchange="loadVoices()">
      <option value="vi-VN" selected>Tiếng Việt</option>
      <option value="en-US">English (US)</option>
    </select>

    <label>Chọn giọng đọc:</label>
    <select id="voiceSelect"></select>

    <button onclick="stopSpeaking()" style="margin-left: 10px;">Dừng đọc</button>
  </div>

  <p><strong>Bạn hỏi:</strong> <span id="question"></span></p>
  <p><strong>AI trả lời:</strong> <span id="answer"></span></p>

<script>
  let voices = [];

  // Tải danh sách giọng nói
  function loadVoices() {
    voices = speechSynthesis.getVoices();
    console.log("Available voices:", voices.map(v => `${v.name} (${v.lang})`));
  }

  window.speechSynthesis.onvoiceschanged = loadVoices;
  loadVoices();

  // Phát tiếng Anh bằng speechSynthesis
  function speakEnglish(text) {
    const englishVoice = voices.find(v =>
      v.lang.startsWith("en") && v.name.toLowerCase().includes("google")
    );
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = "en-US";
    if (englishVoice) utter.voice = englishVoice;
    speechSynthesis.speak(utter);
  }

  // Phát tiếng Việt bằng API FPT.AI
  async function speakVietnameseFPT(text) {
    const res = await fetch("/api/tts", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ text })
    });

    const data = await res.json();
    if (data.audio_url) {
      const audio = new Audio(data.audio_url);
      audio.play();
    } else {
      alert("Không thể phát tiếng Việt.");
    }
  }

  // Nhận diện tiếng và chọn cách phát
  function detectLangAndSpeak(text) {
    const isEnglish = /^[a-zA-Z0-9\s.,!?'"():\-]+$/.test(text.trim());
    if (isEnglish) {
      speakEnglish(text);
    } else {
      speakVietnameseFPT(text);
    }
  }

  // Gửi câu hỏi đến API AI backend
  async function sendToAPI(text) {
    document.getElementById("question").innerText = text;
    try {
      const res = await fetch("/api/ask", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ prompt: text })
      });

      const data = await res.json();
      const answer = data.answer || "Không có câu trả lời.";
      document.getElementById("answer").innerText = answer;
      detectLangAndSpeak(answer);
    } catch (err) {
      console.error("Lỗi fetch:", err);
      document.getElementById("answer").innerText = "Không thể kết nối tới server.";
    }
  }

  // Nhận giọng nói từ người dùng
  function startRecording() {
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'vi-VN';
    recognition.start();
    recognition.onresult = function (event) {
      const text = event.results[0][0].transcript;
      sendToAPI(text);
    };
  }

  // Gửi câu hỏi bằng text
  function askText() {
    const text = document.getElementById("textInput").value;
    if (text.trim()) {
      sendToAPI(text);
    }
  }
</script>

</body>
</html>
