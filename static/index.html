<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Voice AI</title>
</head>
<body>
  <h2>H·ªèi AI b·∫±ng gi·ªçng n√≥i ho·∫∑c g√µ c√¢u h·ªèi</h2>
  <button onclick="startRecording()">üé§ Nh·∫•n ƒë·ªÉ n√≥i</button>

  <div style="margin-top: 20px;">
    <input type="text" id="textInput" placeholder="Ho·∫∑c nh·∫≠p c√¢u h·ªèi t·∫°i ƒë√¢y..." style="width: 300px; padding: 8px;" />
    <button onclick="askText()">G·ª≠i</button>
  </div>

  <div style="margin-top: 20px;">
    <label>Ch·ªçn ng√¥n ng·ªØ:</label>
    <select id="languageSelect" onchange="loadVoices()">
      <option value="vi-VN" selected>Ti·∫øng Vi·ªát</option>
      <option value="en-US">English (US)</option>
      <option value="ja-JP">Japanese</option>
    </select>

    <label>Ch·ªçn gi·ªçng ƒë·ªçc:</label>
    <select id="voiceSelect"></select>

    <button onclick="stopSpeaking()" style="margin-left: 10px;">D·ª´ng ƒë·ªçc</button>
  </div>

  <p><strong>B·∫°n h·ªèi:</strong> <span id="question"></span></p>
  <p><strong>AI tr·∫£ l·ªùi:</strong> <span id="answer"></span></p>

<script>
  let currentUtterance = null;

  function loadVoices() {
    const voiceSelect = document.getElementById("voiceSelect");
    const selectedLang = document.getElementById("languageSelect").value;
    const voices = speechSynthesis.getVoices();

    voiceSelect.innerHTML = "";

    const filteredVoices = voices.filter(voice => voice.lang === selectedLang);

    if (filteredVoices.length === 0) {
      const opt = document.createElement("option");
      opt.textContent = "Kh√¥ng c√≥ gi·ªçng t∆∞∆°ng ·ª©ng";
      voiceSelect.appendChild(opt);
      return;
    }

    filteredVoices.forEach((voice) => {
      const opt = document.createElement("option");
      opt.value = voice.name;
      opt.textContent = `${voice.name} (${voice.lang})`;
      voiceSelect.appendChild(opt);
    });

    // Auto ch·ªçn m·∫∑c ƒë·ªãnh
    const defaultVoiceNameMap = {
      'vi-VN': 'Google Ti·∫øng Vi·ªát',
      'en-US': 'Google US English',
      'ja-JP': 'Google Êó•Êú¨Ë™û'
    };

    const defaultVoiceName = defaultVoiceNameMap[selectedLang];
    const defaultVoice = filteredVoices.find(v => v.name === defaultVoiceName);
    voiceSelect.value = defaultVoice ? defaultVoice.name : filteredVoices[0].name;
  }

  window.speechSynthesis.onvoiceschanged = loadVoices;
  loadVoices();

  function speakText(text) {
    stopSpeaking();
    const voices = speechSynthesis.getVoices();
    const lang = document.getElementById("languageSelect").value;
    const voiceName = document.getElementById("voiceSelect").value;
    const selectedVoice = voices.find(v => v.name === voiceName);

    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = lang;
    if (selectedVoice) {
      utter.voice = selectedVoice;
    }

    currentUtterance = utter;
    speechSynthesis.speak(utter);
  }

  function stopSpeaking() {
    if (speechSynthesis.speaking || speechSynthesis.pending) {
      speechSynthesis.cancel();
    }
  }

  async function sendToAPI(text) {
    document.getElementById("question").innerText = text;
    const lang = document.getElementById("languageSelect").value;

    try {
      const res = await fetch("/api/ask", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ prompt: text, lang })
      });

      const data = await res.json();
      const answer = data.answer || "Kh√¥ng c√≥ c√¢u tr·∫£ l·ªùi.";
      document.getElementById("answer").innerText = answer;

      if (lang === "vi-VN" && data.audio_url) {
        const audio = new Audio(data.audio_url);
        audio.play();
      } else {
        speakText(answer);
      }

    } catch (err) {
      console.error("L·ªói fetch:", err);
      const fallback = "Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi server.";
      document.getElementById("answer").innerText = fallback;

      if (lang !== "vi-VN") {
        speakText(fallback);
      }
    }
  }

  function startRecording() {
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = document.getElementById("languageSelect").value;
    recognition.start();
    recognition.onresult = function (event) {
      const text = event.results[0][0].transcript;
      sendToAPI(text);
    };
    recognition.onerror = function (e) {
      alert("Kh√¥ng th·ªÉ nh·∫≠n di·ªán gi·ªçng n√≥i: " + e.error);
    };
  }

  function askText() {
    const text = document.getElementById("textInput").value;
    if (text.trim()) {
      sendToAPI(text);
    }
  }
</script>
</body>
</html>
