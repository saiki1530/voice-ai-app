<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Voice AI</title>
</head>
<body>
  <h2>Hỏi AI bằng giọng nói hoặc gõ câu hỏi</h2>
  <button onclick="startRecording()">Nhấn để nói</button>

  <div style="margin-top: 20px;">
    <input type="text" id="textInput" placeholder="Hoặc nhập câu hỏi tại đây..." style="width: 300px; padding: 8px;" />
    <button onclick="askText()">Gửi</button>
  </div>

  <div style="margin-top: 20px;">
    <label>Chọn ngôn ngữ:</label>
    <select id="languageSelect" onchange="loadVoices()">
      <option value="vi-VN" selected>Tiếng Việt</option>
      <option value="en-US">English (US)</option>
    </select>

    <label>Chọn giọng đọc:</label>
    <select id="voiceSelect"></select>

    <button onclick="stopSpeaking()" style="margin-left: 10px;">Dừng đọc</button>
  </div>

  <p><strong>Bạn hỏi:</strong> <span id="question"></span></p>
  <p><strong>AI trả lời:</strong> <span id="answer"></span></p>

<script>
  let voices = [];
  let currentUtterance = null;
  let currentAudio = null;

  // Load giọng nói và đổ vào dropdown
  function loadVoices() {
    voices = speechSynthesis.getVoices();
    const lang = document.getElementById("languageSelect").value;
    const voiceSelect = document.getElementById("voiceSelect");

    voiceSelect.innerHTML = "";

    voices
      .filter(v => v.lang === lang)
      .forEach(v => {
        const option = document.createElement("option");
        option.value = v.name;
        option.textContent = `${v.name} (${v.lang})`;
        voiceSelect.appendChild(option);
      });
  }

  window.speechSynthesis.onvoiceschanged = loadVoices;
  loadVoices();

  // Dừng đọc
  function stopSpeaking() {
    speechSynthesis.cancel();
    if (currentAudio) {
      currentAudio.pause();
      currentAudio.currentTime = 0;
    }
  }

  // Phát bằng Web Speech API
  function speakWithSpeechSynthesis(text, lang, voiceName) {
    stopSpeaking();
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = lang;

    const selectedVoice = voices.find(v => v.name === voiceName && v.lang === lang);
    if (selectedVoice) utter.voice = selectedVoice;

    currentUtterance = utter;
    speechSynthesis.speak(utter);
  }

  // Phát tiếng Việt qua FPT.AI
  async function speakVietnameseFPT(text) {
    stopSpeaking();
    try {
      const res = await fetch("/api/tts", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text })
      });

      const data = await res.json();
      if (data.audio_url) {
        currentAudio = new Audio(data.audio_url);
        currentAudio.play();
      } else {
        alert("Không thể phát tiếng Việt.");
      }
    } catch (err) {
      console.error("Lỗi FPT TTS:", err);
    }
  }

  // Xác định và phát
  function detectLangAndSpeak(text) {
    const lang = document.getElementById("languageSelect").value;
    const voiceName = document.getElementById("voiceSelect").value;

    if (lang === "vi-VN") {
      speakVietnameseFPT(text); // dùng FPT.AI nếu có tích hợp
    } else {
      speakWithSpeechSynthesis(text, lang, voiceName);
    }
  }

  // Gửi tới API AI
  async function sendToAPI(text) {
    document.getElementById("question").innerText = text;
    try {
      const res = await fetch("/api/ask", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ prompt: text })
      });

      const data = await res.json();
      const answer = data.answer || "Không có câu trả lời.";
      document.getElementById("answer").innerText = answer;
      detectLangAndSpeak(answer);
    } catch (err) {
      console.error("Lỗi fetch:", err);
      document.getElementById("answer").innerText = "Không thể kết nối tới server.";
    }
  }

  // Gửi câu hỏi bằng text
  function askText() {
    const text = document.getElementById("textInput").value;
    if (text.trim()) {
      sendToAPI(text);
    }
  }

  // Nhận giọng nói từ người dùng
  function startRecording() {
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = "vi-VN"; // có thể thay đổi nếu cần
    recognition.start();
    recognition.onresult = function (event) {
      const text = event.results[0][0].transcript;
      sendToAPI(text);
    };
  }
</script>


</body>
</html>
